version: 1
applications:
  - appRoot: apps/cognexus
    frontend:
      phases:
        preBuild:
          commands:
            - corepack enable
            # Pin pnpm version for reproducible builds in Amplify (kept in sync with root package.json)
            - corepack prepare pnpm@10.15.0 --activate
            # Navigate to repository root and perform workspace install in one command
            - cd ../.. && pnpm install --frozen-lockfile --store-dir=./.pnpm-store
            # Build the shared UI package once so both apps can consume its dist/ outputs
            - cd ../.. && pnpm --filter @cnx/ui build
        build:
          commands:
            # Navigate to repository root and build the cognexus app with type checking disabled
            - cd ../.. && pnpm --filter cognexus exec -- npx next build --no-lint
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - ../../.pnpm-store/**/*
          - .next/cache/**/*
  # Forge app: build/deploy from apps/forge
  - appRoot: apps/forge
    frontend:
      phases:
        preBuild:
          commands:
            - corepack enable
            # Pin pnpm version for reproducible builds in Amplify (kept in sync with root package.json)
            - corepack prepare pnpm@10.15.0 --activate
            # Navigate to repository root and perform workspace install in one command
            - cd ../.. && pnpm install --frozen-lockfile --store-dir=./.pnpm-store
            # Build the shared UI package once so both apps can consume its dist/ outputs
            - cd ../.. && pnpm --filter @cnx/ui build
        build:
          commands:
            # Navigate to repository root and build the forge app
            - cd ../.. && pnpm --filter forge build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - ../../.pnpm-store/**/*
          - .next/cache/**/*
